{% extends 'base.html' %}

{% load static %}
{% load tables %}
{% load i18n %}


{% block head %}

<link rel="stylesheet" href="{% static 'css/css-loader.css' %}">
<script src="https://code.highcharts.com/highcharts.src.js"></script>

{% endblock head %}


{% block content %}

<!-- Loader -->
<div class="htmx-indicator loader loader-default is-active" id="indicator"></div>

<div class="row gx-2 my-2 border-bottom border-primary">
    <div class="col-lg-5 table-responsive">{{ balance }}</div>
    <div class="col-lg-7 table-responsive">{{ expenses }}</div>
</div>

<div class="row gx-2 my-2 border-bottom border-primary">
    <div class="col-lg-5"><div id="chart-expenses-container"></div></div>
    <div class="col-lg-7"><div id="chart-balance-container"></div></div>
</div>

<div class="row my-4">
    <div class="col">
        {% url 'bookkeeping:accounts_worth_new' as url_accounts %}
        <button type="button" class="btn btn-sm btn-outline-success" hx-get="{{ url_accounts }}" hx-target="#dialog"><i class="bi bi-plus"></i> {% translate 'Accounts fact' %}</button>
        {{" "}}
        {% url 'bookkeeping:savings_worth_new' as url_expenses_new %}
        <button type="button" class="btn btn-sm btn-outline-success" hx-get="{{ url_expenses_new }}" hx-target="#dialog"><i class="bi bi-plus"></i> {% translate 'Funds fact' %}</button>
        {{" "}}
        {% url 'bookkeeping:pensions_worth_new' as url_pensions_new %}
        <button type="button" class="btn btn-sm btn-outline-success" hx-get="{{ url_pensions_new }}" hx-target="#dialog"><i class="bi bi-plus"></i> {% translate 'Pensions fact' %}</button>
        {{" "}}
        <button class="btn btn-sm btn-outline-danger" hx-get="{% url 'core:regenerate_balances' %}" hx-indicator="#indicator" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'Balances for all years will be updated.' %}"><i class="bi bi-arrow-repeat"></i> {% translate 'Update balances' %}</button>
    </div>
</div>

<!-- accounts stats -->
<div class="row gx-2">
    <div id="accounts_worth" class="col-lg-7" hx-get="{% url 'bookkeeping:accounts' %}" hx-trigger="afterAccountWorthNew from:body, afterReset from:body, afterSignalAccounts from:body, afterSignal from:body" hx-indicator="#indicator">{{ accounts|safe }}</div>
    <div class="col-lg-3">
        <div class="row">
            <div class="col-lg-12 col-md-6">
                <div>{% info_table balance_short %}</div>
            </div>
            <div class="col-lg-12 col-md-6">
                <div id="no_incomes" hx-get="{% url 'bookkeeping:no_incomes' %}" hx-trigger="afterSavingWorthNew from:body, afterSignalSavings from:body, afterSignal from:body">{{no_incomes|safe}}</div>
            </div>
        </div>
    </div>

    <div class="col-lg-2">
        <div class="row">
            <div class="col-lg-12 col-md-3">
                <!-- Wealth -->
                <div id="wealth" hx-get="{% url 'bookkeeping:wealth' %}" hx-trigger="afterSavingWorthNew from:body, afterSignalSavings from:body, afterSignal from:body">{{wealth|safe}}</div>
            </div>

            <div class="col-lg-12 col-md-3">
                <!-- Average Incomes and Expenses -->
                <div id="avg_incomes">{% info_table averages %}</div>
            </div>

            <div class="col-lg-12 col-md-3">
                <!-- Debts Borrow -->
                <div id="borrow">{% info_table borrow %}</div>
            </div>

            <div class="col-lg-12 col-md-3">
                <!-- Debts Lend -->
                <div id="lend">{% info_table lend %}</div>
            </div>
        </div>
    </div>
</div>


<!-- savings -->
<div class="row mt-3">
    <div id="savings_worth" class="col-lg-12" hx-get="{% url 'bookkeeping:savings' %}" hx-trigger="afterSavingWorthNew from:body, afterSignalSavings from:body, afterSignal from:body" hx-indicator="#indicator">{{savings|safe}}</div>
</div>

<!-- pensions -->
<div class="row mt-3">
    <div id="pensions_worth" class="col-lg-12" hx-get="{% url 'bookkeeping:pensions' %}" hx-trigger="afterPensionWorthNew from:body, afterSignalPensions from:body, afterSignal from:body" hx-indicator="#indicator">{{pensions|safe}}</div>
</div>

<script>
    function compareValues() {
        var c = $('.check');
        c.removeClass('bg-danger text-white');
        if (c[0].outerText != c[1].outerText) {
            c.addClass('bg-danger text-white');
        }
    }

    /* check on page load */
    $(document).ready(compareValues);

    /* check on ajax reload */
    htmx.on("htmx:afterSwap", (e) => {
        compareValues();
    });
</script>

<script src="/static/js/chart_index_balance.js" defer></script>
{{ chart_balance|json_script:"chart-balance-data" }}
<script src="/static/js/chart_index_expenses.js" defer></script>
{{ chart_expenses|json_script:"chart-expenses-data" }}

{% endblock content %}
